---
title: 'Avaliação de Estatística e Experimentação: 1° Parte'
author: "Márlon de Castro Vasconcelos"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  pdf_document:
    toc: yes
  html_document:
    highlight: textmate
    theme: flatly
    number_sections: yes
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
---

```{r Pacotes para gerar o documento final, echo = FALSE, message=FALSE, warning=FALSE}
library(prettydoc)
library(pander)
library(tidyverse)
library(car)
library(rstatix)
library(emmeans)
library(ggpubr)
library(knitr)
library(kableExtra)
library(htmltools)
library(RColorBrewer)
```

----
  
# Uma introdução 
<br>
Avaliar conjuntos de dados nunca é *fácil*. O mais importante é saber o contexto no qual os dados foram obtidos, seu desenho experimental, os objetivos pretendidos e as hipóteses testadas.  

<br>
Ainda que não tenhamos todas as informações há algumas formas de tentarmos minimizar esse *escuro*. Uma delas são identificar os tipos de variáveis, quais são **fatores** e quais são **númericas**. Depois, tentar identificar quais podem ser possíveis variáveis **respostas** e **explicações**. Assim, podemos produzir gráficos para entender o contexto do que está acontecendo.
<br>

----        

# Dados 

<br>
Nessa atividade avaliativa foram deixados três bancos de dados para que fossem devidamente avaliados. O primeiro é o conjunto CO~2~, o segundo Orange e por fim ChickWeigh.  

<br>
Para cada um deles deveria:

```{}
1. Estatistica descritiva para cada base de dados
2. Para cada base de dados:
   a. O discente deverá escolher variáveis para realizar análises        estatísticas pertinentes às escolhas feitas.
        a.1. Identificar o tipo de variável
        a.2. Qual é resposta e qual explicativa
   b. Comentar em cada passo as decisões tomadas.
```

<br>

## Banco CO~2~.

<br>

Esse conjunto de dados avalia a resistência ao frio em uma espécie de gramínea (*Echinochloa crusgalli*) tendo como fatores de estudo: O local onde a planta se oprigina (Type); Identificação de cada "indivíduo" (Plant); Tratamento com quelante (Treatment); Concentração ambiental de CO~2~ em ml.L (conc) e por fim uma variável que mensura o "resultado" do experimento (uptake) em umol/m^2^.sec)

Para maiores informações sobre o conjunto de dados pode ser obtido usando ``help(CO2)``, ou no artigo [Artigo oringial](https://www.jstor.org/stable/1938276).

<br>

## Banco Orange.

<br>

Esse conjunto de dados avalia o efeito da idade (age) sobre a circunferência (circumference) de árvores de Laranja (Tree). Assim a variável idade em sete momentos. A variável árvore, identifica o indivíduo que está sendo monitorado para aquele valor de idade e circunferência.

Para maiores informações sobre o conjunto de dados pode ser obtido usando ``help(Orange)``.
<br>

## Banco ChickWeight .
<br>

Esse conjunto de dados avalia O efeito da dieta (Diet), sobre o ganho precosse de peso (weight) em frangos (Chick) e a variável tempo (Time) avalia o tempo desde o nascimento até a mensuração do peso. Assim, temos que a variável frango controla as mensurações para cada indivíduo.

Para maiores informações sobre o conjunto de dados pode ser obtido usando ``help(ChickWeight)``.

<br>  

## Carregando os bancos de dados

<br>
Esses bancos de dados já se encontram nativos no R. Desta forma, para carregalos basta digitar seu nome no **console** ou por meio do **script** usando a função `data()`, onde dentro do () irá o nome do conjunto desejado.

```{}
# exemplo:
Orange 
# Ou
data(Orange)
```

<br>

# Começando a analisar os dados

<br>
Para começar a analisar quaisquer conjuntos de dadoss é importante conhecer os dados. Saber como foram obtidos, qual o seu desenho experimental, se em DBC, DIC, DQL se são aninhados, isto é, se há uma hierarquia nos fatores de estudo. Isso é importante para saber qual a análise ou modelo mais adequado para avaliar os objetivos e hipóteses pretendidos em cada conjunto de dados.

<br>
Começarei pela ordem com que os dados foram apresentados aqui.

## CO~2~.

```{r carregando o conjunto de dados CO2}
data(CO2)
# Perceba que as letras estão em Maíusculo no mome do conjunto de dados

# # Renomeando a variável Type para Origem
CO2 <- CO2 |> rename(Origem = Type)

glimpse(CO2)
```

<br>

Percebemos que as variáveis Type e Treatment, são fatores; conc e uptake são variáveis do tipo duplo (numéricas) e Plant é uma variável ordinal. Essa variável precisa ser transformada em fator para podermos usa-la no contexto das análsies mostradas durante a disciplina. Isso se deve, para podermos usar essa variável como uma variação intrasujeito (within), isto é, os tratamentos, levam em consideração o indivíduo ao longo do tempo para avaliar o efeito entre sujeitos (between) que a variável Treatment.

No caso desse conjunto de dados temos que realizar uma ANOVA de dois fatores. Tendo como variáveis explicativas, Tratamento e a Origem da Planta.
 

```{r Visualização banco}
# Vamos criar uma tabela para visualizar os dados.
kable(head(CO2, # Conjunto
  10), # Aparecer as 10 primeiras linhas
  col.names = c("Planta", "Origem", "Tratamento", "Conc. CO~2~", "Uptake") # Nomear as colunas 
  ) |>
kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive")
) # Aqui para dar essa "carinha" para a tabela
```

  
### Distribuição da variável Resposta {.tabset .tabset-fade}

<br>

Histograma e Estatistica Descritiva

#### Geral
```{r, echo=FALSE, fig.align='center', fig.height= 5, fig.width=7}
gghistogram(
    CO2,
    x = "uptake", 
    y = "..density..",
    fill = "steelblue", 
    bins = 10, 
    add_density = TRUE,
    xlab = "uptake", 
    ylab = "Frequencia"
)
```


#### Por nível de Tratamento
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.height= 5, fig.width=7}
gghistogram(
    CO2,
    x = "uptake", 
    y = "..density..",
    fill = "Treatment", 
    bins = 10, 
    add_density = TRUE,
    xlab = "Uptake", 
    ylab = "Frequencia"
)
```

#### Por nível Origem.
```{r, echo=FALSE, warning=FALSE, message=FALSE, fig.align='center', fig.height= 5, fig.width=7}
CO2 <- CO2 |> convert_as_factor(conc)
gghistogram(
    CO2,
    x = "uptake", 
    y = "..density..",
    fill = "Origem", 
    bins = 10, 
    add_density = TRUE,
    xlab = "Uptake", 
    ylab = "Frequencia",
    palette = "Dark2"
)
```

#### Estatística Descritiva
```{r, echo=FALSE}
resumo <- CO2 |>
  group_by(Treatment, Origem) |>
  get_summary_stats(uptake, type = "common")
kable(head(resumo)) |> kable_styling(full_width = F)
```
<br>

Vemos pelo hitograma que a distribuição não normal. Temos dois picos, pode ser por causa nas diferenças entre os tratamentos como e sem quelante.

  
### Verificação dos pressupostos do modelo
  
#### Normalidade
A variável dependente ("uptake") deve apresentar distribuição aproximadamente normal dentro de cada nível da variável Tratamento. A normalidade será avaliada pelo teste de Shapiro-Wilk.
  
```{r Shapiro por grupo}
shapiro.co2 <- CO2 %>% group_by(Treatment, Origem) %>% shapiro_test(uptake)
```

```{r}
kable(head(shapiro.co2)) |>
kable_styling(full_width = F)
```


Como suspeitamos nos histogramas, a distribuição da variável uptake não segue distribuição normal.(valores de P < 0,05).

Aqui, podemos transformar a variável uptaque por `log1p` ou `sqrt()`. Isso é uma forma de que os dados possam possuir distribuição normal. Outra abordagem é o uso de modelos que não seguem os pressupostos dos testes paramétricos como os Modelos Lineares Generalisados - GLM. Neles podemos indicar a distribuição dos dados. Contudo, para fins ***didáticos*** proceguirei como se os nossos dados tivessem distribuição normal


<br>  

#### Ausência de *outliers*
Outro pressuposto da ANOVA é a ausência de *outliers* em todos os grupos. Isso pode ser verificado através de um gráfico do tipo boxplot.

```{r Boxplot, fig.align='center', fig.height= 5, fig.width=7}
ggboxplot(CO2, x = "Origem", y = "uptake", fill = "Treatment",
          palette = "Dark2"
          )
```
  
Os gráficos mostram que possuímos *outliers* nos grupos analisados. Esses ouliers são os pontos abaixo dos boxplots.
  
  
### Homogeneidade de variâncias {.tabset .tabset-fade}
Outro pressuposto da ANOVA é que os grupos apresentem variâncias homogêneas. Esse pressuposto será analisado aqui pelo teste de Levene.

#### Tratamento
```{r}
levene.co2.trat <- CO2 |> levene_test(uptake ~ Treatment)
```

````{r, echo = FALSE}
kable(head(levene.co2.trat)) |>
kable_styling(full_width = F)
```

#### Origem
```{r}
levene.co2.origem <- CO2 |> levene_test(uptake ~ Origem)
```

```{r, echo = FALSE}
kable(head(levene.co2.origem)) |>
kable_styling(full_width = F)
```

<br>

Os resultados indicam que as variâncias são homogêneas, uma vez que o teste de Levene apresentou P > 0,05.

  
<br>
  
### Criação do modelo de ANOVA de dois fatores 

Usaremos a função `anova_test()` do pacote `rstatix`.
  
```{r }

resu.co2 <- CO2|> anova_test(uptake ~ Treatment*Origem,
                 type = 3) # Forma de calculo, desconsidera a ordem de entrada dos dados

# Modelo usando transformação anova_test(log1p(uptake) ~ Treatment*Origem, type = 3
```


```{r, echo = FALSE}
kable(head(resu.co2)) |>
kable_styling(full_width = F)
```


### Análise dos resultados do modelo {.tabset .tabset-fade}
 
O resultado nos indica que não há efeito da interação entre o Tratamento com Quelante e a Origem da Planta [F(1,80) = 3.522; p = 0.064]. Assim olharemos os fatores em separado como um teste t. 

Veja que para ambas as variáveis houve diferençã em "uptake". Vemos que para Tratamento com Quelante, a resposta foi melhor quando esse produto esteve presente. Para a Origem, temos que as plantas do Mississipi foram menos tolerantes ao frio.  

<br>

#### Tratamento
```{r fig.align='center', fig.height= 5, fig.width=7}
ggboxplot(CO2, x = "Treatment", y = "uptake", fill = "Gray")
```

#### Origem
```{r fig.align='center', fig.height= 5, fig.width=7}
ggboxplot(CO2, x = "Origem", y = "uptake", fill = "Gray"
          )
```
  
------
  
## Orange.

```{r carregando o conjunto de dados Orange}
data(Orange)
glimpse(Orange)
```

<br>

Aqui temos três variáveis. Árvore (Tree) queé uma variável ordinal, e Idade (age) e Circunferência (circumference) que são do tipo dublo (numéricas).

Aqui podemos pensar em uma regressão, tendo a Idade como variável explicativa e Circunferência como resposta.


```{r, echo = FALSE}
# Vamos criar uma tabela para visualizar os dados.
kable(head(Orange, 7),
  col.names = c("Árvore", "Idade", "Circunferência")) |>
kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive")
)
```

### Distribuição da variável Resposta {.tabset .tabset-fade}

<br>

Histograma e Estatistica Descritiva

#### Geral
```{r, echo=FALSE, fig.align='center', fig.height= 5, fig.width=7}
gghistogram(
    Orange,
    x = "circumference", 
    y = "..density..",
    fill = "steelblue", 
    bins = 10, 
    add_density = TRUE,
    xlab = "Circunferência", 
    ylab = "Frequencia"
)
```


#### Estatística Descritiva
```{r, echo=FALSE}
resumo.orange <- Orange |>
  select(age, circumference) |>
  get_summary_stats(type = "common")
kable(head(resumo.orange)) |> kable_styling(full_width = F)
```

<br>  

Observamos pelo Histograma que a variável circunferência pode não possuir distribuição normal. Mas precisamos testar. Como faremos uma regressão, a homogeneidade e normalidade iremos testar sobre os resíduos.

<br>

### Verificação dos pressupostos do modelo

<br>

Vamos primeiro criar o modelo para depois testar os pressupostos

```{r}

modelo <- lm (circumference ~ age, data = Orange)
```

<br>

#### Normalidade

<br>

```{r}

normalidade_modelo<-shapiro.test(modelo$residuals)
```

<br>  

```{r, echo=FALSE}
estatistica <- normalidade_modelo$statistic
P <- normalidade_modelo$p.value

resu.shapriro <- data.frame(estatistica, P)

kable(head(resu.shapriro),
  col.names =c("Estatistica", "P")) |>
kable_styling(full_width = F)
```

<br>

#### Homogeneidade de Variâncias

<br>

```{r fig.align='center', fig.height= 5, fig.width=7}
# Usaremos o plot do modelo tendo os resíduos x os valores ajsutados. Queremos uma distribuição homogenea acima e abaixo da linha vermelha.

plot(modelo, which = 1, pch = 16)
```

<br>

Tanto a normalidade (P > 0.05), quando para a homogeneidade de variâncias (distribuição razoalvelmente homogenea) os pressupostos foram atendidos. Podemos seguir agora para avaliar se o parâmentro $\beta$~1~ da idade é diferente de zero.

<br>

#### Avaliando o Modelo {.tabset .tabset-fade}

<br>


##### Resultado do Teste
```{r, echo=FALSE}
resultado.aov <- lm (circumference ~ age, data = Orange)
anova.m1 <- anova(resultado.aov)
kable(head(anova.m1)) |>
    kable_styling(full_width = F)
```
  
<br>

Na primera tabela temos o resultado da regressão no formato de uma tabela de ANOVA, na segunda temos os parâmetros para a equação da reta. Assim, temos regressão da idade sobre a circunferência, onde a medida que a laranjeira envelhece sua circunferência aumenta [F(1,33) = 166.4159; P < 0.01]. A equação da reta fica assim,  

<br>

$$\operatorname{y} = 17.4 + 0.106(\operatorname{x}) + \epsilon$$
  
  
##### Parâmetros do Modelo
```{r, echo=FALSE}

resultado <- summary(modelo)
kable(head(resultado$coefficients)) |>
    kable_styling(full_width = F)
```

<br>  
  
Na primera tabela temos o resultado da regressão no formato de uma tabela de ANOVA, na segunda temos os parâmetros para a equação da reta. Assim, temos regressão da idade sobre a circunferência, onde a medida que a laranjeira envelhece sua circunferência aumenta [F(1,33) = 166.4159; P < 0.01]. A equação da reta fica assim,  

<br>

$$\operatorname{y} = 17.4 + 0.106(\operatorname{x}) + \epsilon$$
  
<br>  

#### O Gráfico final para a regressão.

```{r, message=FALSE,fig.align='center', fig.height= 5, fig.width=7}

ggscatter(Orange,
          x = "age",
          y = "circumference",
          add = "reg.line",
          conf.int = TRUE,
          add.params = list(color = "blue",
                            fill = "lightgray"),
          xlab = "Idade da Árvore em dias",
          ylab = "Circunferência mensurada (cm)")


```

----

## ChickWeight.  

<br>
```{r carregando o conjunto de dados ChickWeight}
data(ChickWeight)
glimpse(ChickWeight)
```

<br>

Aqui temos quatro variáveis, sendo Peso (weight), Tempo (Time) como sendo variáveis do tipo duplo (numéricas), Frango (Chick) como Ordinal e por fim a Dieta oferencida (Diet).  

<br>  

Aqui primerio criarei um gráfico com os dados para ver quais caminhos podemos seguir.  

<br>  

```{r fig.align='center', fig.height= 5, fig.width=7}
ggboxplot(ChickWeight,
          x = "Time",
          y = "weight",
          fill = "Diet",
          xlab = "Tempo trascorrido do nascimento à mensuração do Peso (dias)",
          ylab = "Peso mensurado (gr)")
```


<br>  

Veja que temos o tempo como uma informação importante, ainda temos os indivíduos, e aqui ainda que todos os frangos tenham sido mensurados no mesmo tempo, eles não receberam o mesmo tratamento. Isso seria um modelo misto ou aninhado. Pois temos dieta como fator de estudo, dentro desse fator temos o tempo, e os indivíduos como as unidades amostrais.  

<br>

Aqui não temos um valor de corte para o abate, pelo menos não tremos essa informação no conjunto de dados. Podemos simplificar nossa análise e pegar somente os valores de peso e dieta para quando o tempo = 21. Assim, Teremos uma ANOVA de um fator. não quero saber como o tempo influenciou o experimento, quero o resultado final que é aos 21 dias.  

<br>

Logo vamos dividir o conjunto com base em `time == "21"`.  

<br>

```{r}
# Irei criar um novo conjunto de dados

df <- ChickWeight |>
  convert_as_factor(Time) |> 
  filter(Time == "21") # Usando filter == "21", pegaremos somente os dados para         quando o tempo for igual a 21.

```

```{r, echo = FALSE}
kable(head(df, 10),
  col.names = c("Peso", "Tempo", "Frango", "Dieta")) |>
kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive")
)
```

<br>  

```{r fig.align='center', fig.height= 5, fig.width=7}
ggboxplot(df,
          x = "Diet",
          y = "weight",
          fill = "gray",
          xlab = "Dietas utilizadas",
          ylab = "Peso mensurado (gr)")
```


<br>  

Agora podemos realizar uma ANOVA de um fator, sem se preocupar com a influencia do tempo sobre os resultado.  

<br>

### Distribuição da variável Resposta {.tabset .tabset-fade}

<br>

Histograma e Estatistica Descritiva

#### Geral
```{r, echo=FALSE, fig.align='center', fig.height= 5, fig.width=7}
gghistogram(
    df,
    x = "weight", 
    y = "..density..",
    fill = "steelblue", 
    bins = 10, 
    add_density = TRUE,
    xlab = "Peso", 
    ylab = "Frequencia"
)
```


#### Estatística Descritiva
```{r, echo=FALSE}
resumo.df <- df |>
  group_by(Diet) |>
  get_summary_stats(weight, type = "common")
kable(head(resumo.df)) |> kable_styling(full_width = F)
```
<br>


### Verificação dos pressupostos do modelo
  
#### Normalidade
A variável dependente Peso (Weight) deve apresentar distribuição aproximadamente normal dentro de cada nível da variável Dieta (Diet). A normalidade será avaliada pelo teste de Shapiro-Wilk.
  
```{r , message=FALSE}
shapiro.df <- df %>% group_by(Diet) %>% shapiro_test(weight)
```

```{r, echo=FALSE}
kable(head(shapiro.df)) |>
kable_styling(full_width = F)
```

<br>  

Observamos que os valores de P foram maiores que 0.05. Logo a variáel Peso (weight) possui distribuição normal.  

<br>  

#### Homogeneidade de variâncias
A variável dependente Peso (Weight) deve apresentar variâncias iguais em caga nível da da variável Dieta (Diet). A normalidade será avaliada pelo teste de Levene.
  
```{r}
levene.df <- df %>% levene_test(weight~Diet)
```

<br>  

```{r, echo=FALSE}
kable(head(levene.df)) |>
kable_styling(full_width = F)
```

<br>  

Há homogenidade de variâncias entre os níveis de Dieta (Diet).  

<br>

### Ambos os pressupostos foram antendidos, agora podemos realizar a ANOVA de um Fator.

<br>  

```{r, message=FALSE}

modelo.df <- aov(weight~Diet, data = df)
```


```{r, echo=FALSE}
modelo.df.anova <- anova(modelo.df)
kable(head(modelo.df.anova)) |>
kable_styling(full_width = F)
```
   
<br>

O gráfico final fica assim...

<br>

```{r echo=FALSE, fig.align='center', fig.height= 5, fig.width=7}
ggerrorplot(df,
            x = "Diet",
            y = "weight",
     xlab = "Tipo de dieta utilizada", 
    ylab = "Peso mensurada (gr)")
```

<br>


#### *Pos Hoc* 

<br>  

Agora que a ANOVA foi significativa [F(3,41) = 4.65, P = 0.006], ou seja há efeito da dieta sobre o ganho de peso. Precisamos agora saber onde essa diferneça está. Usaremos o teste de Tukey para avaliar as diferenças entre os grupos.  

<br>  

```{r}
resu.tukey <- TukeyHSD(modelo.df)
```

<br>

```{r, echo=FALSE, fig.align='center', fig.height= 5, fig.width=7}

tky <- as.data.frame(resu.tukey$Diet)
tky$pair <- rownames(tky)
ggplot(
  tky, 
  aes(colour = cut(`p adj`,
    c(0, 0.01, 0.05, 1),
    label = c("p<0.01", 
              "p<0.05", 
              "Non-Sig")
  ))
) +
  geom_hline(yintercept = 0,
             lty = "11", 
             colour = "grey30") + 
  geom_errorbar(aes(pair,  
                    ymin = lwr,   
                    ymax = upr),
    width = 0.2
  ) +
  geom_point(aes(pair, diff)) + 
  labs(colour = "") +
  xlab("Comparações Multiplas") + 
  ylab("Diferenças na média") + 
  coord_flip() + 
  theme_bw() + 
  theme(text = element_text(   
    family = "Times New Roman", 
    size = 14  
  )) +
  scale_colour_brewer(palette = "Dark2")

```


<br>  
<br>  


# Uma última Palavra  

<br>

Esse exercício é uma amostra de como os dados podem ser analisados. É importante ter em mente que o conhecimento teórico sobre desenho experimental, sobre o que é um fator de estudo, qual a variável que efetivamente responde nossas perguntas (***objetivo***/***hipóteses***) é de suma importância. Pois e desse conhecimento que o melhor teste e ou modelo poderá ser realizado ou construido.

                                This is the End... dan dan dan